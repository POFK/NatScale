# natscale

A high-performance Python framework for HPC task distribution, load balancing, and monitoring powered by NATS.

# Install NATS
## deploy a NATS service

``` sh
go install github.com/nats-io/nats-server/v2@latest

export PATH=$PATH:$(go env GOPATH)/bin

# -js 表示开启 JetStream 持久化功能
# -m 8222 (可选) 开启 HTTP 监控面板，方便在浏览器看状态
nats-server -js
```

## create a NATS stream

``` sh
nats stream add  --subjects "natscale.tasks.>" --storage=file --ack --retention=work --discard new   --max-msgs 1000000 --max-msg-size=-1 --max-age=-1 --max-msgs-per-subject=-1 --max-bytes=-1 --replicas 1 NATSCALE
```

## useful commands

check the stream info
``` sh
watch -n 10 nats stream info NATSCALE
```


view the stream graph
``` sh
nats stream graph
```

# Usage

Manually send an ACK signal to confirm that the task has been successfully received and processed.

``` python
import time
import natscale as ns

cfg = ns.Config(
    nats_server="nats://127.0.0.1:4222",
    subject="netscale.tasks.*",
    durable_name="all_tasks",
    timeout=3,
    retry = 4,
    auto_ack=False,
)

# manually do ack
with ns.Iterator(cfg) as tasks:
    for data, done in tasks:
        print(f"{data.id} --> {data}")
        time.sleep(1)
        done()
```

Auto send an ACK signal to confirm that the task has been successfully received and processed.

``` python
import time
import natscale as ns
from natscale.task.iter import NatsIterator as Iterator

cfg = ns.Config(
    nats_server="nats://127.0.0.1:4222",
    subject="netscale.tasks.task001",
    durable_name="task001",
    timeout=3,
    retry = 4,
    auto_ack=True,
)

with Iterator(cfg) as tasks:
    for data in tasks:
        print(f"{data.id} --> {data}")
        time.sleep(1)
```

## Note, the `durable_name` always should be set based on subject**

nats stream 中使用 workqueue 时，如果只修改 subject 而不改动 customer 对应的 durable name, 这会导致
subject依然使用customer初次定义时设置的 subject 值，从而使得新的 subject 失效。为了解决这一问题，不
同任务在定义时，可以将 subject and durable_name 绑定，并以 task_id 进行赋值，从而解决 subject filter
的问题, see `examples/debug_ack_iter.py`

# template-pdm-base

This project is generated by pdm template of https://github.com/POFK/template-pdm-base by command:
```
pdm init https://github.com/POFK/template-pdm-base <project_name>
```

also a non-interactive command is:
```
pdm init --name <project_name> --dist -n  https://github.com/POFK/template-pdm-base
```

# first run after initialization
```
pdm install
detect-secrets scan > .secrets.baseline

git add .
pre-commit run -a
```
